name: Notify on Pull Request

on:
  pull_request:
    types: [opened, edited, closed, reopened]
    branches:
      - main

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Notify PR Status via Pushover
        env:
          PUSHOVER_TOKEN: ${{ secrets.PUSHOVER_TOKEN }}
          PUSHOVER_USER: ${{ secrets.PUSHOVER_USER }}
        run: |
          set -euo pipefail
          STATUS="New PR"
          CIRCLE_COLOR="ðŸ”µ"
          PRIORITY="0"
          SOUND="vibrate"
          TTL="129600"

          if [ "${{ github.event.action }}" == "edited" ]; then
            STATUS="Changed PR"
            CIRCLE_COLOR="ðŸŸ¡"
            PRIORITY="0"
            SOUND="vibrate"
            TTL="43200"
          elif [ "${{ github.event.action }}" == "closed" ]; then
            if [ "${{ github.event.pull_request.merged }}" == "true" ]; then
              STATUS="Merged PR"
              CIRCLE_COLOR="ðŸŸ¢"
              PRIORITY="0"
              SOUND="pianobar"
              TTL="129600"
            else
              STATUS="Closed PR"
              CIRCLE_COLOR="ðŸ”´"
              PRIORITY="0"
              SOUND="pushover"
              TTL="604800"
            fi
          elif [ "${{ github.event.action }}" == "reopened" ]; then
            STATUS="Reopened PR"
            CIRCLE_COLOR="ðŸ”µ"
            PRIORITY="0"
            SOUND="vibrate"
            TTL="129600"
          fi

          curl -fsS -m 20 --retry 10 -o /dev/null \
            --form-string "token=${PUSHOVER_TOKEN}" \
            --form-string "user=${PUSHOVER_USER}" \
            --form-string "message=<b>Repository:</b> ${{ github.repository }}<br><b>Branch:</b> ${{ github.ref_name }}<br><b>Pull Request Title:</b> ${{ github.event.pull_request.title }}" \
            --form-string "title=${CIRCLE_COLOR} $STATUS for ${{ github.repository }}: ${{ github.event.pull_request.title }}" \
            --form-string "priority=${PRIORITY}" \
            --form-string "sound=${SOUND}" \
            --form-string "ttl=${TTL}" \
            --form-string "html=1" \
            --form-string "url=${{ github.event.pull_request.html_url }}" \
            --form-string "url_title=View Pull Request" \
            https://api.pushover.net/1/messages.json
